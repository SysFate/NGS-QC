#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
Created on 29/01/15

@author: Matthias Blum
"""

import libngsqc
import os

from datetime import datetime
from PIL import Image
from reportlab.pdfgen.canvas import Canvas
from reportlab.lib import colors
from reportlab.lib.enums import TA_LEFT, TA_RIGHT, TA_CENTER, TA_JUSTIFY
from reportlab.lib.pagesizes import A4
from reportlab.lib.styles import ParagraphStyle
from reportlab.pdfbase import pdfmetrics
from reportlab.pdfbase.ttfonts import TTFont
from reportlab.platypus import Paragraph, Frame, Table
from reportlab.rl_config import defaultPageSize
from reportlab.lib.units import cm


def frame(x, y, width, height, top=0, right=0, bottom=0, left=0):
    return Frame(x, y, width, height, topPadding=top, rightPadding=right, bottomPadding=bottom, leftPadding=left)


def parse_summary(summary):
    """
    Return a dictionary of the information found in a NGS-QC summary file
    :param summary:
    :return:
    """
    run = {
        'date': None,
        'version': None,
        'nodup': None,
        'bgs': None,
        'input_file': None,
        'strandmode': None,
        'genome': None,
        'rep': None,
        'num_rep': None,
        'reads': None,
        'unique_reads': None,
        'bins': None,
        'denqc_90_2.5': None,
        'denqc_50_2.5': None,
        'denqc_90_5': None,
        'denqc_50_5': None,
        'denqc_90_10': None,
        'denqc_50_10': None,
        'simqc_2.5': None,
        'simqc_5': None,
        'simqc_10': None,
        'chromosomes': None,
        'threshold_100': None,
        'threshold_90': None,
        'threshold_50': None,
        'bins2': None,
        'conf_interval': None,
        'bin_size': None,
        'sampling': None
    }

    with open(summary) as f:
        for i, line in enumerate(f):
            if i == 0:
                cols = line.rstrip().split()
                run['version'] = cols[5]
                run['date'] = cols[6] + ' ' + cols[7]
            else:
                field, value = line.rstrip().split('\t', 1)

                if field == 'Clonal reads removed':
                    run['nodup'] = value == 'True'
                elif field == 'Background subtracted':
                    run['bgs'] = value == 'True'
                elif field == 'Input file':
                    run['input_file'] = value
                elif field == 'Genome assembly':
                    run['genome'] = value
                elif field == 'Replicate':
                    run['rep'] = int(value.split('/')[0])
                    run['num_rep'] = int(value.split('/')[-1])
                elif field == 'Strand mode':
                    run['strandmode'] = value
                elif field == 'Windows size':
                    run['bin_size'] = int(value)
                elif field == 'Sampling':
                    run['sampling'] = sorted([float(i.strip()) for i in value.split(',')])
                elif field == 'Reads':
                    run['reads'] = int(value)
                elif field == 'Unique reads':
                    run['unique_reads'] = int(value)
                elif field == 'Bins':
                    run['bins'] = int(value)
                elif field == 'Bins w/o background':
                    run['bins2'] = int(value)
                elif field == 'DenQC_s90_2.5pc(%)':
                    run['denqc_90_2.5'] = float(value)
                elif field == 'DenQC_s50_2.5pc(%)':
                    run['denqc_50_2.5'] = float(value)
                elif field == 'DenQC_s90_5pc(%)':
                    run['denqc_90_5'] = float(value)
                elif field == 'DenQC_s50_5pc(%)':
                    run['denqc_50_5'] = float(value)
                elif field == 'DenQC_s90_10pc(%)':
                    run['denqc_90_10'] = float(value)
                elif field == 'DenQC_s50_10pc(%)':
                    run['denqc_50_10'] = float(value)
                elif field == 'SimQC_2.5pc (DenQC_s90/s50)':
                    value = float(value)

                    if value == float('inf'):
                        continue
                    else:
                        run['simqc_2.5'] = value
                elif field == 'SimQC_5pc (DenQC_s90/s50)':
                    value = float(value)

                    if value == float('inf'):
                        continue
                    else:
                        run['simqc_5'] = value
                elif field == 'SimQC_10pc (DenQC_s90/s50)':
                    value = float(value)

                    if value == float('inf'):
                        continue
                    else:
                        run['simqc_10'] = value
                elif field == 'Chromosomes':
                    run['chromosomes'] = sorted(value.split(','))
                elif field == 'Threshold (100%)':
                    run['threshold_100'] = int(value)
                elif field == 'Conf. interval':
                    run['conf_interval'] = float(value)

        for k, v in run.items():
            if v is None:
                print k
                return None

        return run


def get_stamp(qc_value, quartiles):
    """
    Return the stamp letter for the given QC value
    :param qc_value:
    :param quartiles:
    :return:
    """
    stamp = 'N'

    if qc_value is not None:
        if qc_value > quartiles['q75']:
            stamp = 'A'
        elif quartiles['q75'] >= qc_value > quartiles['q50']:
            stamp = 'B'
        elif quartiles['q50'] >= qc_value > quartiles['q25']:
            stamp = 'C'
        elif qc_value <= quartiles['q25']:
            stamp = 'D'

    return stamp


def insert_header(canvas, page_height, page_width):
    canvas.saveState()
    canvas.setFillColor('#396A92')

    y = page_height - 2.5*cm
    canvas.rect(0, y, page_width, y + 2.5*cm, fill=1, stroke=0)

    p = Paragraph('NGS-QC Generator',
                  ParagraphStyle('header', fontName='Enriqueta-Bold', fontSize=25, textColor='#FFFFFF'))

    p.wrapOn(canvas, page_width, 2.5*cm)
    p.drawOn(canvas, 1.5*cm, y + 2.5*cm / 2)
    canvas.restoreState()


def insert_footer(canvas, width, db_version=None, page=None):
    canvas.setLineWidth(0.25)
    canvas.line(1.5*cm, 1.5*cm, 1.5*cm+width, 1.5*cm)

    style = ParagraphStyle('footer', fontSize=8, alignment=TA_LEFT)
    p = Paragraph('Copyright &copy; {0} '
                  '<a href="http://www.ngs-qc.org">ngs-qc.org</a>'.format(datetime.now().year), style)
    frame(1.5*cm, 0, width, 1.5*cm, top=10, left=10).addFromList([p], canvas)

    style.alignment = TA_CENTER
    if db_version:
        p = Paragraph('Database v{0}'.format(db_version), style)
        frame(1.5*cm, 0, width, 1.5*cm, top=10).addFromList([p], canvas)
    elif page:
        p = Paragraph('Page {0}'.format(page), style)
        frame(1.5*cm, 0, width, 1.5*cm, top=10).addFromList([p], canvas)

    style.alignment = TA_RIGHT
    p = Paragraph('<a href="mailto:contact@ngs-qc.org">contact@ngs-qc.org</a>', style)
    frame(1.5*cm, 0, width, 1.5*cm, top=10, right=10).addFromList([p], canvas)


def write_html(dest, input_file, genome, files, run_time=None):
    html = ('<html>'
            '<head>'
            '<style>'
            'table {border-collapse: collapse;margin: 0 auto;}'
            'td {padding: 5px;border: 1px solid #000;border-collapse: collapse;}'
            'th.a {width: 200px}'
            'h2 {margin: 0;}'
            'td.b {text-align: center;background-color: #396A92; color: #FFFFFF;}'
            '</style></head>'
            '<body>'
            '<table>'
            '<thead>'
            '<tr><th class="a"></th><th colspan="2"></th></tr>'
            '</thead>'
            '<tbody>'
            '<tr><td colspan="3" class="b"><h2>NGS-QC Generator results</h1></td>'
            '<tr><td>Input file</td><td colspan="2">%s</td></tr>'
            '<tr><td>Genome assembly</td><td colspan="2">%s</td></tr>'
            '<tr><td>Page generated on</td><td colspan="2">%s</td></tr>') % (input_file, genome,
                                                                             datetime.now().strftime('%Y-%m-%d %H:%H'))

    if run_time:
        html += "<tr><td>Run time</td><td colspan='2'>{0:.2f} seconds</td></tr>".format(run_time)

    for i, rep_files in enumerate(files):
        html += ("<tr><td>Replicate {0}</td>"
                 "<td><a href=\"{1}\">PDF report</a></td>"
                 "<td><a href=\"{2}\">Supplementary data</a></td></tr>".format(i+1,
                                                                               os.path.basename(rep_files[0]),
                                                                               os.path.basename(rep_files[1])))

    html += "</tbody></table></body></html>"

    with open(dest, 'w') as fo:
        fo.write(html)


def ngsqc_report(run, dest, tmp_dir, target=None, quartiles=None, dbversion=None, uniqbar=True):
    """
    Generate a PDF report of a NGS-QC run
    :param run:         Dictionary of the run info
    :param dest:        PDF output path
    :param tmp_dir:     Directory containing all images
    :param target:      Target molecule
    :param quartiles:   Quartile dictionary
    :param dbversion:   NGS-QC version
    :return:
    """
    # Margin: 1.5 cm left/right

    organism = ''
    for k, v in libngsqc.ORGANISMS.items():
        for g in v:
            if g == run['genome']:
                genus = k.split()[0]
                species = k.split()[-1]
                organism = genus[0].upper() + '. ' + species.lower()

    qc_val_25 = libngsqc.get_qcvalue(run['denqc_50_2.5'], run['simqc_2.5'])
    qc_val_5 = libngsqc.get_qcvalue(run['denqc_50_5'], run['simqc_5'])
    qc_val_10 = libngsqc.get_qcvalue(run['denqc_50_10'], run['simqc_10'])

    if quartiles is not None:
        sub_quartiles = quartiles['bgs'] if run['bgs'] else quartiles['lbgs']
        stamp_25 = get_stamp(qc_val_25, sub_quartiles[2.5])
        stamp_5 = get_stamp(qc_val_5, sub_quartiles[5])
        stamp_10 = get_stamp(qc_val_10, sub_quartiles[10])
        global_stamp = stamp_25 + stamp_5 + stamp_10

    pdfmetrics.registerFont(TTFont('Enriqueta-Bold',
                                   os.path.join(os.path.dirname(__file__), 'fonts', 'Enriqueta-Bold.ttf')))
    pdfmetrics.registerFont(TTFont('Arial-Bold',
                                   os.path.join(os.path.dirname(__file__), 'fonts', 'arial-bold.ttf')))
    pdfmetrics.registerFont(TTFont('Arial',
                                   os.path.join(os.path.dirname(__file__), 'fonts', 'arial.ttf')))
    pdfmetrics.registerFont(TTFont('Capture',
                                   os.path.join(os.path.dirname(__file__), 'fonts', 'capture_it.ttf')))

    cell_style = ParagraphStyle('cell',
                                fontSize=10, textColor='#000000')
    title_style = ParagraphStyle('title',
                                 fontSize=16, leading=18, spaceBefore=4, spaceAfter=4)
    subtitle_style = ParagraphStyle('subtitle',
                                    fontSize=10, leading=12, spaceBefore=4, spaceAfter=4, alignment=TA_RIGHT)
    normal_style = ParagraphStyle('normal',
                                  fontSize=10, leading=12, spaceBefore=4, spaceAfter=4, alignment=TA_JUSTIFY)
    legend_style = ParagraphStyle('legend',
                                  fontSize=8, leading=12, spaceBefore=4, spaceAfter=4, alignment=TA_JUSTIFY)

    canvas = Canvas(dest, pagesize=A4)
    (page_width, page_height) = defaultPageSize
    p_width = page_width - 1.5 * 2 * cm

    canvas.setTitle("NGS-QC Generator Report")
    canvas.setAuthor("Hinrich Gronemeyer group")

    canvas.setLineWidth(0.25)

    ######################
    #   HEADER
    ######################
    insert_header(canvas, page_height, page_width)

    ######################
    #   DISP PLOT
    ######################
    y = page_height - 420
    path = os.path.join(tmp_dir, 'pc_s50_s70_s90_replicate_{0}.png'.format(run['rep']))

    # Images generated by Gnuplots are in "P" mode. We want them in RGBA to avoid a Pillow warning
    im = Image.open(path).convert('RGBA')
    im.save(path)
    canvas.drawImage(path, page_width/2, y, width=p_width/2, height=p_width/2)

    # Legend
    y -= 100
    p = Paragraph('<b>Effect of random sampling on the profile</b>. '
                  'This figure illustrates the influence '
                  'of the random sampling subsets (90%: black; 70%: blue; 50%: red) '
                  'on the recovered read count Intensity (recRCI) per bin. '
                  'The dark-green vertical line represents the background threshold.', legend_style)
    frame(page_width/2, y, p_width/2, 100, left=5).addFromList([p], canvas)

    ######################
    # TITLE / SUBTITLE
    ######################
    y = page_height - 2.5 * cm - 20
    p = Paragraph('<b>Data Quality Report</b>', title_style)
    p.wrapOn(canvas, p_width, 20)
    p.drawOn(canvas, 1.5*cm, y)

    p = Paragraph(run['date'], subtitle_style)
    p.wrapOn(canvas, p_width, 20)
    p.drawOn(canvas, 1.5*cm, y)

    ######################
    # LINE
    ######################
    y -= 5
    canvas.line(1.5*cm, y, page_width - 1.5 * cm, y)

    ######################
    # FILE NAME
    ######################
    y -= 35

    p = Paragraph('File name: ' + run['input_file'], normal_style)
    frame(1.5*cm, y, p_width, 30, left=5).addFromList([p], canvas)

    ######################
    # CHIP-SEQ STAMP
    ######################
    if quartiles is not None:
        y = page_height - 125
        canvas.saveState()
        if run['bgs']:
            canvas.setFillColor(colors.green)
            canvas.setStrokeColor(colors.green)
        else:
            canvas.setFillColor(colors.fidred)
            canvas.setStrokeColor(colors.fidred)

        canvas.rotate(-7)
        canvas.setFont('Arial-Bold', 14)
        canvas.drawCentredString(page_width - 1.5*cm - 185, y + 45, 'Global QC certification')
        canvas.setFont('Capture', 45)
        canvas.drawCentredString(page_width - 230, y + 5, global_stamp)
        canvas.setLineWidth(4)
        canvas.rect(page_width - 320, y, 180, 60, stroke=True, fill=False)

        if uniqbar:
            ######################
            # UNIQUE READS BAR
            ######################
            unique_ratio = float(run['unique_reads']) / run['reads']
            # canvas.saveState()
            canvas.setLineWidth(1)
            canvas.setStrokeColor('#000000')
            canvas.setFillColor('#CE68F5')
            p = canvas.beginPath()

            xbar = page_width / 2 - 5
            ybar = page_height - 120
            p.rect(xbar, ybar, 7, 30)
            canvas.drawPath(p, fill=0, stroke=1)

            # Green part
            canvas.setFillColor(colors.green)
            p = canvas.beginPath()
            p.rect(xbar + 0.5, ybar+0.5, 6, 30*unique_ratio)
            canvas.drawPath(p, fill=1, stroke=0)

            # Red part
            canvas.setFillColor(colors.red)
            p = canvas.beginPath()
            p.rect(xbar + 0.5, ybar+30*unique_ratio, 6, 30*(1-unique_ratio))
            canvas.drawPath(p, fill=1, stroke=0)

            canvas.rotate(90)
            canvas.setFillColor(colors.black)
            canvas.setFont('Arial', 7)
            canvas.drawCentredString(737, -310, 'URs (%)')
        canvas.restoreState()

    ######################
    # DATA SET INFO
    ######################
    y -= 55
    organism_str = ' ({})'.format(organism)
    unique_ratio = float(run['unique_reads']) / run['reads']

    if unique_ratio >= 0.5:
        p = Paragraph('{0} ({1:.2f}%)'.format(libngsqc.num_format(run['unique_reads']), unique_ratio*100), cell_style)
    else:
        p = Paragraph("%s (<font color=fidred>%.2f%%</font>)" % (libngsqc.num_format(run['unique_reads']),
                                                                 unique_ratio*100), cell_style)

    data = [['Dataset informations', None],
            ['Total reads', libngsqc.num_format(run['reads'])],
            ['Unique reads (URs)', p],
            ['Genome assembly', run['genome'] + organism_str],
            ['Target molecule', target]]

    t = Table(data, style=[('GRID', (0, 0), (-1, -1), 0.5, colors.black),
                           ('FONTSIZE', (0, 0), (-1, -1), 10),
                           ('BACKGROUND', (0, 0), (1, 0), colors.grey),
                           ('TEXTCOLOR', (0, 0), (1, 0), colors.white),
                           ('SPAN', (0, 0), (1, 0)),
                           ('SPAN', (0, 0), (1, 0))], colWidths=[p_width/4, p_width/4])

    y = page_height - 210
    t.wrapOn(canvas, p_width / 2, 10)
    t.drawOn(canvas, 1.5*cm, y)

    ######################
    # QC PARAMETERS
    ######################
    y -= 155
    data = [['QC parameters', ''],
            ['Sampling percentages', ', '.join(str(e) for e in run['sampling'])],
            ['Windows size (bp)', run['bin_size']],
            ['Replicate number', '{0}/{1}'.format(run['rep'], run['num_rep'])],
            ['Sampled strand(s)', run['strandmode']],
            ['Referenced chromosomes', len(run['chromosomes']) if run['chromosomes'] else None],
            ['Background subtraction', 'On' if run['bgs'] else 'Off'],
            ['Clonal reads removal', 'On' if run['nodup'] else 'Off']]

    t = Table(data, style=[('GRID', (0, 0), (-1, -1), 0.5, colors.black),
                           ('BACKGROUND', (0, 0), (1, 0), colors.darkgrey),
                           ('TEXTCOLOR', (0, 0), (1, 0), colors.white),
                           ('SPAN', (0, 0), (1, 0))], colWidths=[p_width/4, p_width/4])

    t.wrapOn(canvas, p_width / 2, 50)
    t.drawOn(canvas, 1.5*cm, y)

    ######################
    # INDICATORS
    ######################
    y -= 100

    considered_reads = run['unique_reads'] if run['nodup'] else run['reads']
    data = [['Results', None, None],
            ['Considered reads*', None, libngsqc.num_format(considered_reads)],
            ['QC values\ndenQC (50%) / simQC', '2.5%', '{0:.3f} / {1:.3f}'.format(run['denqc_50_2.5'], run['simqc_2.5'])],
            [None, '5%', '{0:.3f} / {1:.3f}'.format(run['denqc_50_5'], run['simqc_5'])],
            [None, '10%', '{0:.3f} / {1:.3f}'.format(run['denqc_50_10'], run['simqc_10'])]]

    t = Table(data, style=[
        ('GRID', (0, 0), (-1, -1), 0.5, colors.black),
        ('BACKGROUND', (0, 0), (2, 0), colors.lightgrey),
        ('SPAN', (0, 0), (2, 0)),
        ('SPAN', (0, 1), (1, 1)),
        ('SPAN', (0, 2), (0, 4)),
        ('VALIGN', (0, 2), (0, 2), 'MIDDLE'),
        ('FONTSIZE', (0, 2), (0, 2), 9)
    ], colWidths=[0.75*p_width/4, 0.25*p_width/4, p_width/4])

    t.wrapOn(canvas, p_width / 2, 50)
    t.drawOn(canvas, 1.5*cm, y)

    y -= 20
    p = Paragraph('* Reads taken into account to compute the QC indicators.', legend_style)
    frame(1.5*cm, y, p_width/2, 20, left=5, top=5).addFromList([p], canvas)

    ######################
    # LINE
    ######################
    y -= 2
    canvas.line(page_width/4, y, 0.75*page_width, y)

    ######################
    # LOCAL QC
    ######################
    y -= 40
    p = Paragraph('<b>Read count intensity profile illustrated '
                  'in the context of its corresponding local QC indicators (heatmap)</b>. '
                  'On the upper figure, genes are represented by green-colored rectangles. '
                  'Overlapping genes are represented by a deeper green and TSS are displayed as a small dark bar. '
                  'The lower figure is a zoom of the center of the first figure.', legend_style)
    frame(1.5*cm, y, p_width, 42, top=5).addFromList([p], canvas)

    imgs = {}
    string = 'localqc.rep{0}.region'.format(run['rep'])
    for f in os.listdir(tmp_dir):
        if f.startswith(string):
            idx = int(f.replace(string, '')[:-4])
            imgs[idx] = os.path.join(tmp_dir, f)

    imgs_width = 0.95 * p_width
    margin_left = 0.05 * p_width

    colorbar = os.path.join(tmp_dir, 'colorbar.png')
    try:
        im = Image.open(colorbar)
    except IOError:
        insert_colorbar = False
    else:
        insert_colorbar = True
        colb_w, colb_h = im.size
        del im

    num_page = 1

    for idx, path in sorted(imgs.items()):
        if idx == 3:
            # We placed the first region (low+high resolution) on the first page
            # Now, move to the next page
            insert_footer(canvas, p_width, db_version=dbversion)
            canvas.showPage()
            insert_header(canvas, page_height, page_width)
            y = page_height - 2.5*cm - 10
            num_page += 1

        if num_page == 2 and idx % 2 != 0:
            # We only want high resolution images on page 2
            # These regions have a even number in the list
            continue

        im = Image.open(path)
        img_w, img_h = im.size
        del im

        if insert_colorbar:
            img_h *= imgs_width / img_w
        else:
            img_h *= p_width / img_w

        y -= img_h

        if y <= 1.5*cm:
            num_page += 1
            if num_page == 3:
                break

        if insert_colorbar:
            canvas.drawImage(path, 1.5*cm + margin_left, y, width=imgs_width, height=img_h)
            colb_w *= img_h / colb_h
            canvas.drawImage(colorbar, 1.5*cm, y, width=colb_w, height=img_h)
            insert_colorbar = False
        else:
            canvas.drawImage(path, 1.5*cm, y, width=p_width, height=img_h)

        y -= 10

    # Last page's footer
    insert_footer(canvas, p_width, db_version=dbversion)

    canvas.save()
    return dest


def init(summary, dest, tmp_dir, target=None, quartiles=None, dbversion=None):
    run = parse_summary(summary)

    if run is None:
        return None

    return ngsqc_report(run, dest, tmp_dir, target, quartiles, dbversion)


def insert_colorbar_gv(canvas, top, img, img_h):
    """
    Insert the dispersion colorbar
    :param canvas:  Canvas to write on
    :param top:     Page top
    :param img:     Image path
    :param img_h:  Image desired height (since regions and colorbar have the same height)
    :return:
    """

    im = Image.open(img)
    width, height = im.size
    img_w = width * img_h / height
    del im
    canvas.drawImage(img, 25, top - 75 - img_h, width=img_w, height=img_h)


def gv_report(dest, tmp_dir):
    canvas = Canvas(dest, pagesize=A4)
    (page_width, page_height) = defaultPageSize
    top = page_height
    p_width = page_width - 1.5 * 2 * cm
    canvas.setTitle("LocalQCs Report")
    canvas.setAuthor("Hinrich Gronemeyer group")

    pdfmetrics.registerFont(TTFont('Enriqueta-Bold',
                                   os.path.join(os.path.dirname(__file__), 'fonts', 'Enriqueta-Bold.ttf')))

    ####################################
    # Header
    ####################################
    insert_header(canvas, page_height, page_width)

    ####################################
    # Footer
    ####################################
    num_page = 1
    insert_footer(canvas, p_width, page=num_page)

    images = sorted(os.path.join(tmp_dir, f) for f in os.listdir(tmp_dir) if f.endswith('.png') and f != 'colorbar.png')
    colorbar = os.path.join(tmp_dir, 'colorbar.png')

    ####################################
    # Place images
    ####################################
    y_pos = top - 75

    for img in sorted(images):
        im = Image.open(img)
        # Image's real size
        img_w, img_h = im.size
        del im

        # Resize image to to fit to the page keeping the same ratio
        img_h *= p_width / img_w
        y_pos -= img_h

        if y_pos <= 1.5*cm:
            # Not enough space: start a new page
            insert_colorbar_gv(canvas, top, colorbar, img_h)
            canvas.showPage()
            num_page += 1
            insert_header(canvas, page_height, page_width)
            insert_footer(canvas, p_width, page=num_page)
            y_pos = top - 75 - img_h

        canvas.drawImage(img, 2 * cm, y_pos, width=p_width, height=img_h)
        y_pos -= 15  # Margin bottom

    insert_colorbar_gv(canvas, top, colorbar, img_h)
    canvas.save()
